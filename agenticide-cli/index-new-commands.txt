
// ========== INTELLIGENT ANALYSIS ==========

program
    .command("analyze")
    .description("Analyze current project with LSP and build symbol index")
    .option("-v, --verbose", "Show detailed output")
    .action(async (options) => {
        try {
            const Database = require("better-sqlite3");
            const IntelligentAnalyzer = require("../agenticide-core/intelligentAnalyzer");
            const dbPath = path.join(CONFIG_DIR, "cli.db");
            const db = new Database(dbPath);
            const analyzer = new IntelligentAnalyzer(db);
            
            console.log(chalk.cyan("\nüîç Analyzing project...\n"));
            const results = await analyzer.analyzeProject(1, process.cwd());
            
            if (results) {
                console.log(chalk.green(`\n‚úÖ Analysis complete!`));
                console.log(chalk.gray(`   Files: ${results.newFiles + results.changedFiles} analyzed`));
                console.log(chalk.gray(`   Symbols: ${results.totalSymbols || 0} found\n`));
            }
            
            analyzer.close();
            db.close();
        } catch (e) { 
            console.error(chalk.red(`\n‚ùå Error: ${e.message}\n`));
            if (options.verbose) console.error(e.stack);
        }
    });

program
    .command("index")
    .description("Build semantic search index from analyzed code")
    .action(async () => {
        try {
            const Database = require("better-sqlite3");
            const SemanticSearch = require("../agenticide-core/semanticSearch");
            const dbPath = path.join(CONFIG_DIR, "cli.db");
            const db = new Database(dbPath);
            const search = new SemanticSearch(db);
            
            console.log(chalk.cyan("\nüìö Building search index...\n"));
            await search.indexProject(1);
            console.log(chalk.green("\n‚úÖ Index built successfully!\n"));
            
            db.close();
        } catch (e) { 
            console.error(chalk.red(`\n‚ùå Error: ${e.message}\n`));
        }
    });

program
    .command("search <query>")
    .description("Search code semantically")
    .option("-n, --limit <number>", "Number of results", "5")
    .action(async (query, options) => {
        try {
            const Database = require("better-sqlite3");
            const SemanticSearch = require("../agenticide-core/semanticSearch");
            const dbPath = path.join(CONFIG_DIR, "cli.db");
            const db = new Database(dbPath);
            const search = new SemanticSearch(db);
            
            console.log(chalk.cyan(`\nüîé Searching for: "${query}"\n`));
            const results = search.search(query, parseInt(options.limit));
            
            if (results.length === 0) {
                console.log(chalk.yellow("No results found. Try running 'agenticide index' first.\n"));
            } else {
                results.forEach((r, i) => {
                    const score = (r.similarity * 100).toFixed(0);
                    console.log(chalk.bold(`${i + 1}. ${r.symbol_name}`) + chalk.gray(` [${score}%]`));
                    console.log(chalk.dim(`   ${r.file_path}:${r.symbol_kind}`));
                    if (r.description) {
                        console.log(chalk.gray(`   ${r.description.substring(0, 80)}...`));
                    }
                    console.log();
                });
            }
            
            db.close();
        } catch (e) { 
            console.error(chalk.red(`\n‚ùå Error: ${e.message}\n`));
        }
    });

program
    .command("search-stats")
    .description("Show semantic search statistics")
    .action(async () => {
        try {
            const Database = require("better-sqlite3");
            const dbPath = path.join(CONFIG_DIR, "cli.db");
            const db = new Database(dbPath);
            
            const embeddings = db.prepare("SELECT COUNT(*) as count FROM code_embeddings").get();
            const symbols = db.prepare("SELECT COUNT(*) as count FROM code_symbols").get();
            const searches = db.prepare("SELECT COUNT(*) as count FROM search_history").get();
            
            console.log(chalk.cyan("\nüìä Search Statistics:\n"));
            console.log(chalk.gray(`   Indexed symbols: ${embeddings?.count || 0}`));
            console.log(chalk.gray(`   Total symbols: ${symbols?.count || 0}`));
            console.log(chalk.gray(`   Search history: ${searches?.count || 0}\n`));
            
            db.close();
        } catch (e) { 
            console.error(chalk.red(`\n‚ùå Error: ${e.message}\n`));
        }
    });

