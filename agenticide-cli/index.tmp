#!/usr/bin/env node

const { Command } = require('commander');
const chalk = require('chalk');
const inquirer = require('inquirer');
const ora = require('ora');
const boxen = require('boxen');
const fs = require('fs');
const path = require('path');
const { spawn } = require('child_process');

const program = new Command();

// Package info
const pkg = require('./package.json');

// Configuration
const CONFIG_DIR = path.join(process.env.HOME, '.agenticide');
const CONFIG_FILE = path.join(CONFIG_DIR, 'config.json');
const TASKS_FILE = path.join(process.cwd(), '.agenticide-tasks.json');

// ASCII Art Banner
const banner = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                       â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—       â•‘
â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•       â•‘
â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘          â•‘
â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘          â•‘
â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘          â•‘
â•‘  â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•          â•‘
â•‘                                                       â•‘
â•‘         AGENTICIDE CLI - AI Coding Assistant         â•‘
â•‘          ACP + MCP | Claude + Copilot                â•‘
â•‘                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

// ACP Client for communicating with agents
class ACPClient {
    constructor() {
        this.agents = new Map();
        this.sessions = new Map();
    }

    async initializeClaudeAgent() {
        const spinner = ora('Initializing Claude Code agent...').start();
        
        try {
            const claudePath = await this.findClaudePath();
            if (!claudePath) {
                spinner.fail('Claude Code not found');
                console.log(chalk.yellow('\nInstall Claude Code:'));
                console.log(chalk.cyan('  curl -fsSL https://claude.ai/install.sh | bash\n'));
                return false;
            }

            // Start Claude Code in ACP mode
            const agent = spawn(claudePath, ['--acp'], {
                stdio: ['pipe', 'pipe', 'pipe']
            });

            this.agents.set('claude', { process: agent, type: 'acp' });
            
            spinner.succeed('Claude Code agent ready');
            return true;
        } catch (error) {
            spinner.fail(`Failed: ${error.message}`);
            return false;
        }
    }

    async findClaudePath() {
        const possiblePaths = [
            '/usr/local/bin/claude',
            '/opt/homebrew/bin/claude',
            path.join(process.env.HOME, '.local/bin/claude')
        ];

        for (const p of possiblePaths) {
            if (fs.existsSync(p)) {
                return p;
            }
        }

        return null;
    }

    async sendPrompt(agentName, prompt, context = {}) {
        const agent = this.agents.get(agentName);
        if (!agent) {
            return `Agent '${agentName}' not initialized`;
        }

        // Create session if needed
        let sessionId = this.sessions.get(agentName);
        if (!sessionId) {
            sessionId = `session-${Date.now()}`;
            this.sessions.set(agentName, sessionId);
        }

        // Send ACP request via JSON-RPC
        const request = {
            jsonrpc: '2.0',
            id: Date.now(),
            method: 'session/prompt',
            params: {
                sessionId,
                prompt,
                context
            }
        };

        return new Promise((resolve) => {
            agent.process.stdin.write(JSON.stringify(request) + '\n');
            
            // Listen for response
            let buffer = '';
            const responseHandler = (data) => {
                buffer += data.toString();
                
                // Try to parse response
                try {
                    const lines = buffer.split('\n');
                    for (const line of lines) {
                        if (line.trim()) {
                            const response = JSON.parse(line);
                            if (response.id === request.id) {
                                agent.process.stdout.removeListener('data', responseHandler);
                                resolve(response.result?.content || response.result || 'No response');
                                return;
                            }
                        }
                    }
                } catch (e) {
                    // Not complete JSON yet, keep buffering
                }
            };

            agent.process.stdout.on('data', responseHandler);
            
            // Timeout after 30 seconds
            setTimeout(() => {
                agent.process.stdout.removeListener('data', responseHandler);
                resolve('Request timeout');
            }, 30000);
        });
    }

    dispose() {
        for (const [name, agent] of this.agents.entries()) {
            if (agent.process) {
                agent.process.kill();
            }
        }
        this.agents.clear();
    }
}

// Global ACP client
let acpClient = null;

// Load config
function loadConfig() {
    if (!fs.existsSync(CONFIG_DIR)) {
        fs.mkdirSync(CONFIG_DIR, { recursive: true });
    }
    
    if (fs.existsSync(CONFIG_FILE)) {
        return JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf8'));
    }
    
    return {
        defaultProvider: 'claude',
        useACP: true,
        claudeApiKey: '',
        mcpServers: []
    };
}

// Save config
function saveConfig(config) {
    fs.writeFileSync(CONFIG_FILE, JSON.stringify(config, null, 2));
}

// Load tasks
function loadTasks() {
    if (fs.existsSync(TASKS_FILE)) {
        return JSON.parse(fs.readFileSync(TASKS_FILE, 'utf8'));
    }
    return [];
}

// Save tasks
function saveTasks(tasks) {
    fs.writeFileSync(TASKS_FILE, JSON.stringify(tasks, null, 2));
}

// Commands

// Init command
program
    .command('init')
    .description('Initialize Agenticide in current directory')
    .action(async () => {
        console.log(chalk.cyan(banner));
        
        const spinner = ora('Initializing...').start();
        
        // Create config
        const config = loadConfig();
        
        // Initialize tasks file
        saveTasks([]);
        
        spinner.succeed('Initialized successfully!');
        console.log(chalk.green('\nâœ… Agenticide ready in this directory'));
        console.log(chalk.gray('\nRun: agenticide chat'));
    });

// Chat command
program
    .command('chat')
    .description('Start interactive AI chat')
    .option('-p, --provider <provider>', 'AI provider (claude|copilot|auto)', 'auto')
    .action(async (options) => {
        console.log(chalk.cyan(banner));
        
        // Initialize ACP client
        acpClient = new ACPClient();
        await acpClient.initializeClaudeAgent();
        
        console.log(chalk.green('\nðŸ’¬ Chat started. Type your message (or "exit" to quit)\n'));
        
        // Interactive chat loop
        while (true) {
            const { message } = await inquirer.prompt([
                {
                    type: 'input',
                    name: 'message',
                    message: chalk.cyan('You:'),
                    prefix: ''
                }
            ]);
            
            if (message.toLowerCase() === 'exit' || message.toLowerCase() === 'quit') {
                break;
            }
            
            if (!message.trim()) {
                continue;
            }
            
            const spinner = ora('Thinking...').start();
            
            try {
                // Get context
                const context = {
                    cwd: process.cwd(),
                    files: fs.readdirSync(process.cwd()).filter(f => !f.startsWith('.')).slice(0, 10)
                };
                
                // Send to agent
                const response = await acpClient.sendPrompt('claude', message, context);
                
                spinner.stop();
                console.log(chalk.green('\nðŸ¤– Claude:\n'));
                console.log(boxen(response, {
                    padding: 1,
                    margin: 1,
                    borderStyle: 'round',
                    borderColor: 'green'
                }));
                console.log('');
            } catch (error) {
                spinner.fail('Error: ' + error.message);
            }
        }
        
        console.log(chalk.yellow('\nGoodbye! ðŸ‘‹\n'));
        
        if (acpClient) {
            acpClient.dispose();
        }
        process.exit(0);
    });

// Task commands
program
    .command('task:add <description>')
    .description('Add a new task')
    .action((description) => {
        const tasks = loadTasks();
        tasks.push({
            id: Date.now(),
            description,
            completed: false,
            createdAt: new Date().toISOString()
        });
        saveTasks(tasks);
        console.log(chalk.green('âœ… Task added: ' + description));
    });

program
    .command('task:list')
    .description('List all tasks')
    .action(() => {
        const tasks = loadTasks();
        
        if (tasks.length === 0) {
            console.log(chalk.yellow('No tasks yet. Add one with: agenticide task:add "description"'));
            return;
        }
        
        console.log(chalk.cyan('\nðŸ“‹ Tasks:\n'));
        tasks.forEach((task, index) => {
            const status = task.completed ? chalk.green('âœ“') : chalk.gray('â—‹');
            const text = task.completed ? chalk.gray(task.description) : task.description;
            console.log(`  ${status} ${index + 1}. ${text}`);
        });
        console.log('');
    });

program
    .command('task:complete <id>')
    .description('Mark task as complete')
    .action((id) => {
        const tasks = loadTasks();
        const taskId = parseInt(id);
        const task = tasks.find(t => t.id === taskId);
        
        if (!task) {
            console.log(chalk.red('Task not found'));
            return;
        }
        
        task.completed = true;
        saveTasks(tasks);
        console.log(chalk.green('âœ… Task completed: ' + task.description));
    });

// Code commands
program
    .command('explain <file>')
    .description('Explain code in file')
    .action(async (file) => {
        if (!fs.existsSync(file)) {
            console.log(chalk.red('File not found: ' + file));
            return;
        }
        
        const code = fs.readFileSync(file, 'utf8');
        const spinner = ora('Analyzing code...').start();
        
        acpClient = new ACPClient();
        await acpClient.initializeClaudeAgent();
        
        const response = await acpClient.sendPrompt('claude', 
            `Explain this code:\n\n${code}`, 
            { file, language: path.extname(file) }
        );
        
        spinner.stop();
        console.log(chalk.green('\nðŸ“– Explanation:\n'));
        console.log(boxen(response, {
            padding: 1,
            margin: 1,
            borderStyle: 'round'
        }));
        
        acpClient.dispose();
    });

// Config commands
program
    .command('config:set <key> <value>')
    .description('Set configuration value')
    .action((key, value) => {
        const config = loadConfig();
        config[key] = value;
        saveConfig(config);
        console.log(chalk.green(`âœ… Set ${key} = ${value}`));
    });

program
    .command('config:show')
    .description('Show configuration')
    .action(() => {
        const config = loadConfig();
        console.log(chalk.cyan('\nâš™ï¸  Configuration:\n'));
        console.log(boxen(JSON.stringify(config, null, 2), {
            padding: 1,
            borderStyle: 'round'
        }));
    });

// Status command
program
    .command('status')
    .description('Show Agenticide status')
    .action(async () => {
        console.log(chalk.cyan(banner));
        
        const config = loadConfig();
        const tasks = loadTasks();
        
        const spinner = ora('Checking agents...').start();
        
        // Check Claude Code
        const acpClient = new ACPClient();
        const claudeReady = await acpClient.initializeClaudeAgent();
        
        spinner.stop();
        
        console.log(chalk.cyan('\nðŸ“Š Status:\n'));
        console.log(`  ${claudeReady ? chalk.green('âœ…') : chalk.red('âŒ')} Claude Code (ACP)`);
        console.log(`  ${chalk.cyan('â„¹ï¸')}  Tasks: ${tasks.length} (${tasks.filter(t => !t.completed).length} pending)`);
        console.log(`  ${chalk.cyan('â„¹ï¸')}  Provider: ${config.defaultProvider}`);
        console.log(`  ${chalk.cyan('â„¹ï¸')}  Directory: ${process.cwd()}`);
        console.log('');
        
        acpClient.dispose();
    });

// Version
program
    .version(pkg.version, '-v, --version', 'Output the version number')
    .description(chalk.cyan('Agenticide CLI - AI Coding Assistant with ACP + MCP'));

// Help
program.on('--help', () => {
    console.log('');
    console.log(chalk.cyan('Examples:'));
    console.log('  $ agenticide init');
    console.log('  $ agenticide chat');
    console.log('  $ agenticide task:add "Implement login feature"');
    console.log('  $ agenticide explain src/app.js');
    console.log('  $ agenticide status');
    console.log('');
});

// Parse arguments
